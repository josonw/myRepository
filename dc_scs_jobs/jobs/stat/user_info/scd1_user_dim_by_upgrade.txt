procedure scd1_user_dim_by_upgrade(pd_date date default trunc(sysdate - 1))
  is
    ld_begin date;
    ld_end date;
  begin
    ld_begin := trunc(pd_date);
    ld_end := ld_begin + 1;

    pkg_manage_tools.add_common_log(ps_name => 'pkg_user_info',
                                  ps_subname => 'scd1_user_dim_by_upgrade',
                                  ps_operation => 'begin');


    execute immediate 'truncate table user_upgrade_tmp';

    insert into user_upgrade_tmp
    (fbpid, fuid, flevel)
    select fbpid, fuid, max(flevel) as flevel
    from user_upgrade_stg uus
    where uus.fgrade_at >= ld_begin and uus.fgrade_at < ld_end and flevel < 300
    group by fbpid, fuid;

    commit;

    pkg_manage_tools.add_common_log(ps_name => 'pkg_user_info',
                                  ps_subname => 'scd1_user_dim_by_upgrade',
                                  ps_operation => 'user_upgrade_tmp');

    update analysis.user_dim ud
    set ud.fgrade =
    (
        select uut.flevel
        from user_upgrade_tmp uut
        where ud.fbpid = uut.fbpid and ud.fuid = uut.fuid and ud.fgrade != uut1.flevel
    )
    where exists
    (
        select 1
        from user_upgrade_tmp uut1
        where ud.fbpid = uut1.fbpid and ud.fuid = uut1.fuid and ud.fgrade != uut1.flevel
    );

    commit;

    pkg_manage_tools.add_common_log(ps_name => 'pkg_user_info',
                                  ps_subname => 'scd1_user_dim_by_upgrade',
                                  ps_operation => 'end');
    exception
    when others then
    pkg_manage_tools.add_common_log(ps_name      => 'pkg_user_info',
                                    ps_subname   => 'scd1_user_dim_by_upgrade',
                                    ps_operation => 'end',
                                    ps_err       => 'error');
    end;